{% extends 'index_master.html' %}

{% block content %}
<div class="right_col" role="main">
  <h2>Dashboard (Access - tiempo real)</h2>

  <div class="card mb-3 p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="btn-toolbar" role="toolbar">
        <button id="btn-refresh" class="btn btn-primary btn-lg mr-2"><i class="fa fa-refresh"></i> Actualizar</button>
        <a id="btn-export" class="btn btn-success btn-lg mr-2" href="#"><i class="fa fa-file-excel-o"></i> Exportar a Excel</a>
        <button id="btn-clear" class="btn btn-secondary mr-2"><i class="fa fa-eraser"></i> Limpiar filtros</button>
        <button id="btn-print" class="btn btn-outline-dark"><i class="fa fa-print"></i> Imprimir</button>
      </div>
      <div class="text-right small text-muted"><span id="loader" style="display:none">Calculando…</span> <span id="last-updated"></span></div>
    </div>

    <form id="filters-form" class="form-inline">
      <label class="mr-2">Desde</label>
      <input type="date" id="desde" class="form-control mr-2" />
      <label class="mr-2">Hasta</label>
      <input type="date" id="hasta" class="form-control mr-2" />

      <label class="mr-2">Institución</label>
      <select id="filter-institucion" class="form-control mr-2"></select>

      <label class="mr-2">Género</label>
      <select id="filter-genero" class="form-control mr-2"><option value="ALL">Todos</option><option value="M">M</option><option value="F">F</option></select>

      <label class="mr-2">Rango edad</label>
      <select id="filter-edad" class="form-control mr-2"><option value="">(Todos)</option><option value="0-12">0–12</option><option value="13-17">13–17</option><option value="18-30">18–30</option><option value="31-59">31–59</option><option value="60+">60+</option></select>
    </form>

    <!-- Totals bar (visible) -->
    <div id="totals" class="mt-3 d-flex">
      <div class="p-3 mr-3 bg-white border" style="min-width:180px;text-align:center;">
        <div class="small text-muted">Total atenciones</div>
        <div id="total-atenciones" class="h3">—</div>
      </div>
      <div class="p-3 mr-3 bg-white border" style="min-width:200px;text-align:center;">
        <div class="small text-muted">Total recaudo</div>
        <div id="total-recaudo" class="h3">—</div>
      </div>
      <div class="p-3 bg-white border" style="min-width:220px;text-align:center;">
        <div class="small text-muted">Promedio diario</div>
        <div id="promedio-diario" class="h4">—</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Número de atenciones (mes)</h5>
        <canvas id="chartAtenciones"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Valor recaudado por consulta / medicina (mes)</h5>
        <canvas id="chartRecaudo"></canvas>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5>Atenciones por institución</h5>
        <canvas id="chartInstitucion"></canvas>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5>Atenciones por género</h5>
        <canvas id="chartGenero"></canvas>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5>Atenciones por rango de edad</h5>
        <canvas id="chartEdad"></canvas>
      </div>
    </div>
  </div>

  <hr />
  <div id="alerts"></div>

  <!-- Summary table (Excel-like) -->
  <div class="card p-3 mb-3">
    <h5>Resumen</h5>
    <div class="table-responsive">
      <table id="summary-table" class="table table-striped table-bordered" style="width:100%">
        <thead><tr><th>Métrica</th><th>Valor</th></tr></thead>
        <tbody>
          <tr><td>Total atenciones</td><td id="s_total_atenciones">—</td></tr>
          <tr><td>Total recaudo</td><td id="s_total_recaudo">—</td></tr>
          <tr><td>Promedio diario</td><td id="s_promedio_diario">—</td></tr>
          <tr><td>% Hombres</td><td id="s_pct_hombres">—</td></tr>
          <tr><td>% Mujeres</td><td id="s_pct_mujeres">—</td></tr>
          <tr><td>Edad promedio (estimada)</td><td id="s_edad_promedio">—</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  function $id(id){ return document.getElementById(id); }
  function showError(msg){ const a = document.getElementById('alerts'); a.innerHTML = `<div class="alert alert-danger">${msg}</div>`; setTimeout(()=>a.innerHTML='',7000); }
  function showInfo(msg){ const a = document.getElementById('alerts'); a.innerHTML = `<div class="alert alert-info">${msg}</div>`; setTimeout(()=>a.innerHTML='',5000); }

  const ctxA = $id('chartAtenciones').getContext('2d');
  const ctxR = $id('chartRecaudo').getContext('2d');
  const ctxI = $id('chartInstitucion').getContext('2d');
  const ctxG = $id('chartGenero').getContext('2d');
  const ctxE = $id('chartEdad').getContext('2d');
  let cA,cR,cI,cG,cE;

  const STORAGE_KEY = 'dashboard_filters_v1';

  function defaultDates(){ const today = new Date(); const prior = new Date(); prior.setMonth(today.getMonth()-1); if(!$id('desde').value) $id('desde').value = prior.toISOString().slice(0,10); if(!$id('hasta').value) $id('hasta').value = today.toISOString().slice(0,10);} 
  defaultDates();

  function saveFilters(){ const state = {desde:$id('desde').value, hasta:$id('hasta').value, institucion:$id('filter-institucion').value, genero:$id('filter-genero').value, edad_range:$id('filter-edad').value}; localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadFilters(){ const s = localStorage.getItem(STORAGE_KEY); if(!s) return; try{ const st = JSON.parse(s); if(st.desde) $id('desde').value = st.desde; if(st.hasta) $id('hasta').value = st.hasta; if(st.institucion) $id('filter-institucion').value = st.institucion; if(st.genero) $id('filter-genero').value = st.genero; if(st.edad_range) $id('filter-edad').value = st.edad_range; }catch(e){ console.warn('Bad dashboard state', e); }}

  function setLoading(on){ const L = $id('loader'); if(on){ L.style.display='inline-block'; $id('btn-refresh').disabled=true; $id('btn-clear').disabled=true; $id('btn-export').disabled=true; } else { L.style.display='none'; $id('btn-refresh').disabled=false; $id('btn-clear').disabled=false; $id('btn-export').disabled=false; }}
  function setLastUpdated(){ const el = $id('last-updated'); const now = new Date(); el.textContent = 'Datos actualizados a ' + now.toLocaleTimeString(); }

  async function fetchJson(url, opts={}){ const r = await fetch(url, opts); if(!r.ok) { const err = await r.json().catch(()=>({error:r.statusText})); throw new Error(err.error||r.statusText); } return r.json(); }

  async function populateInstituciones(){ try{ const inst = await fetchJson('/dashboard/api/atenciones-institucion/'); const sel = $id('filter-institucion'); sel.innerHTML = '<option value="">(Todas)</option>' + inst.map(i=>`<option value="${i.institucion}">${i.institucion} (${i.total})</option>`).join(''); }catch(e){ console.warn('No pude cargar instituciones', e); }}

  function formatCurrency(v){ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}).format(v); }

  function computeAndRenderSummary(data, desde, hasta){
    const at = data.atenciones_mes || [];
    const vc = data.valor_consulta || [];
    const vm = data.valor_medicina || [];
    const gen = data.genero || [];
    const ed = data.edad || [];

    const totalAt = at.reduce((s,x)=>s+(x.numero||0),0);
    const totalVc = vc.reduce((s,x)=>s+(x.total||0),0);
    const totalVm = vm.reduce((s,x)=>s+(x.total||0),0);
    const totalRecaudo = totalVc + totalVm;

    // days inclusive
    let days = 1;
    try{ const d1 = new Date(desde); const d2 = new Date(hasta); days = Math.max(1, Math.round((d2 - d1)/(1000*3600*24))+1); }catch(e){ days = 1; }
    const promedio = days? (totalAt/days):0;

    const totalGen = gen.reduce((s,x)=>s+(x.total||0),0);
    const hombres = (gen.find(x=>x.genero==='M')||{total:0}).total || 0;
    const mujeres = (gen.find(x=>x.genero==='F')||{total:0}).total || 0;
    const pctH = totalGen? Math.round((hombres/totalGen)*100):0;
    const pctM = totalGen? Math.round((mujeres/totalGen)*100):0;

    // edad promedio estimada usando midpoints
    const midpoints = {'0-12':6,'13-17':15,'18-30':24,'31-59':45,'60+':65};
    const totalEdadCount = ed.reduce((s,x)=>s+(x.total||0),0);
    const edadSum = ed.reduce((s,x)=>s + ((midpoints[x.rango]||0) * (x.total||0)),0);
    const edadProm = totalEdadCount? Math.round((edadSum/totalEdadCount)) : 0;

    // render
    $id('total-atenciones').textContent = totalAt;
    $id('total-recaudo').textContent = formatCurrency(totalRecaudo);
    $id('promedio-diario').textContent = promedio? promedio.toFixed(1) : '0.0';

    $id('s_total_atenciones').textContent = totalAt;
    $id('s_total_recaudo').textContent = formatCurrency(totalRecaudo);
    $id('s_promedio_diario').textContent = promedio? promedio.toFixed(1) : '0.0';
    $id('s_pct_hombres').textContent = pctH + '%';
    $id('s_pct_mujeres').textContent = pctM + '%';
    $id('s_edad_promedio').textContent = edadProm? (edadProm + ' años') : '—';

    // messages
    if(totalAt === 0 && totalRecaudo === 0){ showError('Sin resultados'); }
    else { showInfo('Datos cargados correctamente'); }
  }

  async function refresh(){
    const desde = $id('desde').value; const hasta = $id('hasta').value;
    if(!desde || !hasta){ showError('Define rango de fechas'); return; }
    saveFilters();
    setLoading(true);
    try{
      const qs = new URLSearchParams({inicio:desde, fin:hasta});
      const inst = $id('filter-institucion').value; if(inst) qs.set('institucion', inst);
      const gen = $id('filter-genero').value; if(gen) qs.set('genero', gen);
      const edad = $id('filter-edad').value; if(edad) qs.set('edad_range', edad);

      const data = await fetchJson('/dashboard/api/data/?' + qs.toString());

      // charts
      const at = data.atenciones_mes || [];
      const labels = at.map(x=>x.mes);
      const nums = at.map(x=>x.numero);
      if(cA) cA.destroy(); cA = new Chart(ctxA,{type:'bar',data:{labels:labels,datasets:[{label:'Atenciones',data:nums,backgroundColor:'rgba(54,162,235,0.7)'}]}});

      const vc = data.valor_consulta || [];
      const vm = data.valor_medicina || [];
      const joinedLabels = vc.map(x=>x.mes);
      const vc_vals = vc.map(x=>x.total);
      const vm_vals = vm.map(x=>x.total);
      if(cR) cR.destroy(); cR = new Chart(ctxR,{type:'bar',data:{labels:joinedLabels,datasets:[{label:'Consulta',data:vc_vals,backgroundColor:'rgba(75,192,192,0.7)'},{label:'Medicina',data:vm_vals,backgroundColor:'rgba(255,99,132,0.7)'}]}});

      const inst_d = data.instituciones || [];
      if(cI) cI.destroy(); cI = new Chart(ctxI,{type:'pie',data:{labels:inst_d.map(x=>x.institucion),datasets:[{data:inst_d.map(x=>x.total),backgroundColor:['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f']} ]}});

      const gen_d = data.genero || [];
      if(cG) cG.destroy(); cG = new Chart(ctxG,{type:'doughnut',data:{labels:gen_d.map(x=>x.genero),datasets:[{data:gen_d.map(x=>x.total),backgroundColor:['#59a14f','#edc949']} ]}});

      const ed = data.edad || [];
      if(cE) cE.destroy(); cE = new Chart(ctxE,{type:'bar',data:{labels:ed.map(x=>x.rango),datasets:[{label:'Atenciones',data:ed.map(x=>x.total),backgroundColor:'rgba(123,31,162,0.7)'}]}});

      // export link (parte diario uses 'hasta')
      $id('btn-export').href = `/dashboard/export/parte-diario/?fecha=${hasta}`;

      // compute totals and render summary table
      computeAndRenderSummary(data, desde, hasta);

      setLastUpdated();

    }catch(e){ console.error(e); showError(e.message||String(e)); }
    finally{ setLoading(false); }
  }

  // UI bindings
  $id('btn-refresh').addEventListener('click', function(e){ e.preventDefault(); refresh(); });
  $id('btn-clear').addEventListener('click', function(e){ e.preventDefault(); localStorage.removeItem(STORAGE_KEY); $id('filter-institucion').value=''; $id('filter-genero').value='ALL'; $id('filter-edad').value=''; defaultDates(); refresh(); });
  $id('btn-print').addEventListener('click', function(){ window.print(); });
  // export is an anchor; no special handler required

  // filters change events
  ['desde','hasta','filter-institucion','filter-genero','filter-edad'].forEach(id=>{ const el = $id(id); if(el) el.addEventListener('change', ()=>{ saveFilters(); refresh(); }); });

  // initial population: load institutions first so saved filter can be applied
  populateInstituciones().then(()=>{ loadFilters(); refresh(); }).catch(e=>{ console.warn('populateInstituciones failed', e); loadFilters(); refresh(); });
})();
</script>
{% endblock %}
