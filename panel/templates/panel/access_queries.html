{% extends 'index_master.html' %}

{% block content %}
<div class="right_col" role="main">
  <h2>Consultas sobre Access</h2>

  {% if not access_available %}
    <div class="alert alert-warning">No hay un archivo Access disponible. Carga uno en <a href="{% url 'panel:import_access' %}">Importar Access</a>.</div>
  {% endif %}

  <div class="row">
    <div class="col-md-6">
      <h4>Consultas guardadas</h4>
      <ul class="list-group">
        {% for q in queries %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ q.name }}</strong>
              <div class="text-muted small">{{ q.sql|truncatechars:120 }}</div>
            </div>
            <form method="post" style="margin:0">
              {% csrf_token %}
              <input type="hidden" name="action" value="run_saved">
              <input type="hidden" name="query_id" value="{{ q.id }}">
              <button class="btn btn-primary btn-sm">Ejecutar</button>
            </form>
          </li>
        {% empty %}
          <li class="list-group-item">No hay consultas guardadas.</li>
        {% endfor %}
      </ul>

      <h5 class="mt-3">Guardar nueva consulta</h5>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_query">
        <div class="form-group">
          <label>Nombre</label>
          <input class="form-control" name="name" required />
        </div>
        <div class="form-group">
          <label>SQL (solo SELECT)</label>
          <textarea class="form-control" name="sql" rows="4" required></textarea>
        </div>
        <button class="btn btn-success">Guardar</button>
      </form>
    </div>

    <div class="col-md-6">
      <h4>Ejecutar consulta ad-hoc</h4>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="run_sql">
        <div class="form-group">
          <label>Contraseña (si procede)</label>
          <input class="form-control" name="access_password" placeholder="Dejar en blanco para usar la guardada en la sesión" />
        </div>
        <div class="form-group">
          <label>SQL (solo SELECT)</label>
          <textarea class="form-control" name="sql" rows="6" required></textarea>
        </div>
        <div class="form-group">
          <label>Formato</label>
          <select class="form-control" name="format">
            <option value="html">HTML</option>
            <option value="csv">CSV</option>
          </select>
        </div>
        <button class="btn btn-primary">Ejecutar</button>
      </form>

      {% if error %}
        <div class="alert alert-danger mt-3">Error: {{ error }}</div>
      {% endif %}

      {% if result %}
        <h5 class="mt-3">Resultados ({{ result|length }} filas)</h5>
        <div class="table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                {% for c in columns %}<th>{{ c }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in result %}
                <tr>
                  {% for v in row %}
                    <td>{{ v }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}