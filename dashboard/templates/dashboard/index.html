{% extends 'index_master.html' %}

{% block content %}
<div class="right_col" role="main">
  <h2>Dashboard (Access - tiempo real)</h2>

  <div class="card mb-3 p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="btn-toolbar" role="toolbar">
        <button id="btn-refresh" class="btn btn-primary btn-lg mr-2"><i class="fa fa-refresh"></i> Actualizar</button>
        <a id="btn-export" class="btn btn-success btn-lg mr-2" href="#"><i class="fa fa-file-excel-o"></i> Exportar a Excel</a>
        <button id="btn-clear" class="btn btn-secondary mr-2"><i class="fa fa-eraser"></i> Limpiar filtros</button>
        <button id="btn-print" class="btn btn-outline-dark"><i class="fa fa-print"></i> Imprimir</button>
      </div>
      <div class="text-right small text-muted"><span id="loader" style="display:none">Calculando…</span> <span id="last-updated"></span></div>
    </div>

    <form id="filters-form" class="form-inline">
      <label class="mr-2">Desde</label>
      <input type="date" id="desde" class="form-control mr-2" />
      <label class="mr-2">Hasta</label>
      <input type="date" id="hasta" class="form-control mr-2" />

      <label class="mr-2">Institución</label>
      <select id="filter-institucion" class="form-control mr-2"></select>

      <label class="mr-2">Género</label>
      <select id="filter-genero" class="form-control mr-2"><option value="ALL">Todos</option><option value="M">M</option><option value="F">F</option></select>

      <label class="mr-2">Rango edad</label>
      <select id="filter-edad" class="form-control mr-2"><option value="">(Todos)</option><option value="0-12">0–12</option><option value="13-17">13–17</option><option value="18-30">18–30</option><option value="31-59">31–59</option><option value="60+">60+</option></select>
    </form>

    <!-- Totals bar (visible) -->
    <div id="totals" class="mt-3 d-flex">
      <div class="p-3 mr-3 bg-white border" style="min-width:180px;text-align:center;">
        <div class="small text-muted">Total atenciones</div>
        <div id="total-atenciones" class="h3">—</div>
      </div>
      <div class="p-3 mr-3 bg-white border" style="min-width:200px;text-align:center;">
        <div class="small text-muted">Total recaudo</div>
        <div id="total-recaudo" class="h3">—</div>
      </div>
      <div class="p-3 bg-white border" style="min-width:220px;text-align:center;">
        <div class="small text-muted">Promedio diario</div>
        <div id="promedio-diario" class="h4">—</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Número de atenciones (mes)</h5>
        <canvas id="chartAtenciones"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Valor recaudado por consulta / medicina (mes)</h5>
        <canvas id="chartRecaudo"></canvas>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Distribución de atenciones por institución</h5>
        <canvas id="chartInstitucion"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Atenciones por día</h5>
        <canvas id="chartAtencionesDay"></canvas>
    </div>
  </div>

  <hr />
  <div id="alerts"></div>

  <!-- Summary table (Excel-like) -->
  <div class="card p-3 mb-3">
    <h5>Resumen</h5>
    <div class="table-responsive">
      <table id="summary-table" class="table table-striped table-bordered" style="width:100%">
        <thead><tr><th>Métrica</th><th>Valor</th></tr></thead>
        <tbody>
          <tr><td>Total atenciones</td><td id="s_total_atenciones">—</td></tr>
          <tr><td>Total recaudo</td><td id="s_total_recaudo">—</td></tr>
          <tr><td>Promedio diario</td><td id="s_promedio_diario">—</td></tr>
          <tr><td>% Hombres</td><td id="s_pct_hombres">—</td></tr>
          <tr><td>% Mujeres</td><td id="s_pct_mujeres">—</td></tr>
          <tr><td>Edad promedio (estimada)</td><td id="s_edad_promedio">—</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Detail table (Excel-like) -->
  <div class="card p-3 mb-3" id="detail-card">
    <h5>Detalle (estilo Excel)</h5>
    <div id="detail-container" class="table-responsive" style="max-height:380px; overflow-y:auto;">
      <table id="detail-table" class="table table-sm table-striped table-bordered" style="width:100%">
        <thead>
          <tr><th>Fecha atención</th><th>Paciente</th><th>Servicio</th><th>Institución</th><th style="text-align:right">Valor consulta</th><th style="text-align:right">Valor medicina</th><th style="text-align:right">Total</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="detail-empty" style="display:none" class="text-muted mt-2">Sin registros</div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  function $id(id){ return document.getElementById(id); }
  function showError(msg){ const a = document.getElementById('alerts'); a.innerHTML = `<div class="alert alert-danger">${msg}</div>`; setTimeout(()=>a.innerHTML='',7000); }
  function showInfo(msg){ const a = document.getElementById('alerts'); a.innerHTML = `<div class="alert alert-info">${msg}</div>`; setTimeout(()=>a.innerHTML='',5000); }

  const ctxA = $id('chartAtenciones').getContext('2d');
  const ctxR = $id('chartRecaudo').getContext('2d');
  const ctxI = $id('chartInstitucion').getContext('2d');
  const ctxG = $id('chartGenero').getContext('2d');
  const ctxE = $id('chartEdad').getContext('2d');
  let cA,cR,cI,cG,cE;

  const STORAGE_KEY = 'dashboard_filters_v1';

  function defaultDates(){ const today = new Date(); const prior = new Date(); prior.setMonth(today.getMonth()-1); if(!$id('desde').value) $id('desde').value = prior.toISOString().slice(0,10); if(!$id('hasta').value) $id('hasta').value = today.toISOString().slice(0,10);} 
  defaultDates();

  function saveFilters(){ const state = {desde:$id('desde').value, hasta:$id('hasta').value, institucion:$id('filter-institucion').value, genero:$id('filter-genero').value, edad_range:$id('filter-edad').value}; localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadFilters(){ const s = localStorage.getItem(STORAGE_KEY); if(!s) return; try{ const st = JSON.parse(s); if(st.desde) $id('desde').value = st.desde; if(st.hasta) $id('hasta').value = st.hasta; if(st.institucion) $id('filter-institucion').value = st.institucion; if(st.genero) $id('filter-genero').value = st.genero; if(st.edad_range) $id('filter-edad').value = st.edad_range; }catch(e){ console.warn('Bad dashboard state', e); }}

  function setLoading(on){ const L = $id('loader'); if(on){ L.style.display='inline-block'; L.textContent = 'Actualizando…'; $id('btn-refresh').disabled=true; $id('btn-clear').disabled=true; $id('btn-export').disabled=true; } else { L.style.display='none'; L.textContent = ''; $id('btn-refresh').disabled=false; $id('btn-clear').disabled=false; $id('btn-export').disabled=false; }}
  function setLastUpdated(){ const el = $id('last-updated'); const now = new Date(); el.textContent = 'Datos actualizados a ' + now.toLocaleTimeString(); }

  function fetchJson(url, opts={}){ const r = await fetch(url, opts); if(!r.ok) { const text = await r.text(); let err; try { err = JSON.parse(text); } catch(e) { err = {error: r.statusText || text}; } throw new Error(err.error||r.statusText); } return r.json(); }

  async function populateInstituciones(){ try{ const inst = await fetchJson('/dashboard/api/atenciones-institucion/'); const sel = $id('filter-institucion'); sel.innerHTML = '<option value="">(Todas)</option>' + inst.map(i=>`<option value="${i.institucion}">${i.institucion} (${i.total})</option>`).join(''); }catch(e){ console.warn('No pude cargar instituciones', e); }}

  function formatCurrency(v){ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}).format(v); }

  function computeAndRenderSummary(data, desde, hasta){
    // Prefer authoritative server-side KPIs when available
    const tot = data.totales || {};
    const at = tot.atenciones || 0;
    const consulta = tot.total_consulta || 0;
    const medicina = tot.total_medicina || 0;
    const totalGeneral = tot.total_general || (consulta + medicina);

    // Render KPIs: show '—' for empty/no-data
    $id('total-atenciones').textContent = at ? at : '—';
    $id('total-recaudo').textContent = (consulta || medicina) ? formatCurrency(totalGeneral) : '—';
    $id('promedio-diario').textContent = at ? ( (at / Math.max(1, Math.round((new Date(hasta)-new Date(desde))/(1000*3600*24))+1)).toFixed(1) ) : '—';

    $id('s_total_atenciones').textContent = at ? at : '—';
    $id('s_total_recaudo').textContent = (consulta || medicina) ? formatCurrency(totalGeneral) : '—';
    $id('s_promedio_diario').textContent = at ? ( (at / Math.max(1, Math.round((new Date(hasta)-new Date(desde))/(1000*3600*24))+1)).toFixed(1) ) : '—';
    $id('s_pct_hombres').textContent = data.genero && data.genero.length ? ( (data.genero.find(x=>x.genero==='M')||{total:0}).total / data.genero.reduce((s,x)=>s+(x.total||0),0) * 100 ).toFixed(0) + '%' : '—';
    $id('s_pct_mujeres').textContent = data.genero && data.genero.length ? ( (data.genero.find(x=>x.genero==='F')||{total:0}).total / data.genero.reduce((s,x)=>s+(x.total||0),0) * 100 ).toFixed(0) + '%' : '—';
    $id('s_edad_promedio').textContent = data.edad && data.edad.length ? (function(){ const mid={'0-12':6,'13-17':15,'18-30':24,'31-59':45,'60+':65}; const totalCount = data.edad.reduce((s,x)=>s+(x.total||0),0); const sum = data.edad.reduce((s,x)=>s + ((mid[x.rango]||0)*(x.total||0)),0); return totalCount ? Math.round(sum/totalCount) + ' años' : '—'; })() : '—';

    // messages
    if(!at && !consulta && !medicina){ showError('Sin registros en el período seleccionado'); }
    else { showInfo('Datos actualizados para el período seleccionado'); }
  }

  function renderDetailTable(data){
    const rows = data.detalle || [];
    const tbody = $id('detail-table').querySelector('tbody');
    tbody.innerHTML = '';
    if(!rows.length){ $id('detail-empty').style.display='block'; $id('detail-container').style.display='none'; return; }
    $id('detail-empty').style.display='none'; $id('detail-container').style.display='block';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.fecha||''}</td><td>${r.paciente||''}</td><td>${r.servicio||''}</td><td>${r.institucion||''}</td><td style="text-align:right">${formatCurrency(r.valor_consulta||0)}</td><td style="text-align:right">${formatCurrency(r.valor_medicina||0)}</td><td style="text-align:right">${formatCurrency(r.total||0)}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function refresh(){
    const desde = $id('desde').value; const hasta = $id('hasta').value;
    if(!desde || !hasta){ showError('Define rango de fechas'); return; }
    saveFilters();
    setLoading(true);
    try{
      const qs = new URLSearchParams({inicio:desde, fin:hasta});
      const inst = $id('filter-institucion').value; if(inst) qs.set('institucion', inst);
      const gen = $id('filter-genero').value; if(gen) qs.set('genero', gen);
      const edad = $id('filter-edad').value; if(edad) qs.set('edad_range', edad);

      const data = await fetchJson('/dashboard/api/data/?' + qs.toString());

      // charts: only render if the dataset contains data; otherwise hide
      const at = data.atenciones_mes || [];
      if(at.length){ const labels = at.map(x=>x.mes); const nums = at.map(x=>x.numero); if(cA) cA.destroy(); cA = new Chart($id('chartAtencionesDay').getContext('2d'),{type:'bar',data:{labels:labels,datasets:[{label:'Atenciones',data:nums,backgroundColor:'rgba(54,162,235,0.7)'}]}}); $id('chartAtencionesDay').parentElement.style.display='block'; } else { if(cA) cA.destroy(); $id('chartAtencionesDay').parentElement.style.display='none'; }

      const vc = data.valor_consulta || [];
      const vm = data.valor_medicina || [];
      if(vc.length || vm.length){ const joinedLabels = vc.map(x=>x.mes); const vc_vals = vc.map(x=>x.total); const vm_vals = vm.map(x=>x.total); if(cR) cR.destroy(); cR = new Chart(ctxR,{type:'bar',data:{labels:joinedLabels,datasets:[{label:'Consulta',data:vc_vals,backgroundColor:'rgba(75,192,192,0.7)'},{label:'Medicina',data:vm_vals,backgroundColor:'rgba(255,99,132,0.7)'}]}}); $id('chartRecaudo').parentElement.style.display='block'; } else { if(cR) cR.destroy(); $id('chartRecaudo').parentElement.style.display='none'; }

      const inst_d = data.instituciones || [];
      if(inst_d.length){ if(cI) cI.destroy(); cI = new Chart(ctxI,{type:'pie',data:{labels:inst_d.map(x=>x.institucion),datasets:[{data:inst_d.map(x=>x.total),backgroundColor:['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f']} ]}}); $id('chartInstitucion').parentElement.style.display='block'; } else { if(cI) cI.destroy(); $id('chartInstitucion').parentElement.style.display='none'; }

      const gen_d = data.genero || [];
      if(cG) cG.destroy(); cG = new Chart(ctxG,{type:'doughnut',data:{labels:gen_d.map(x=>x.genero),datasets:[{data:gen_d.map(x=>x.total),backgroundColor:['#59a14f','#edc949']} ]}});

      const ed = data.edad || [];
      if(cE) cE.destroy(); cE = new Chart(ctxE,{type:'bar',data:{labels:ed.map(x=>x.rango),datasets:[{label:'Atenciones',data:ed.map(x=>x.total),backgroundColor:'rgba(123,31,162,0.7)'}]}});

      // export link: include filters so export mirrors current query
      const exportQs = new URLSearchParams(); if(desde) exportQs.set('inicio', desde); exportQs.set('fin', hasta); if(inst) exportQs.set('institucion', inst); if(gen) exportQs.set('genero', gen); if(edad) exportQs.set('edad_range', edad);
      $id('btn-export').href = `/dashboard/export/detalle/?` + exportQs.toString();

      // compute totals and render summary table
      computeAndRenderSummary(data, desde, hasta);

      // render detalle table (Excel-style)
      renderDetailTable(data);

      setLastUpdated();

    }catch(e){ console.error(e); showError(e.message||String(e)); }
    finally{ setLoading(false); }
  }

  // UI bindings
  $id('btn-refresh').addEventListener('click', function(e){ e.preventDefault(); refresh(); });
  $id('btn-clear').addEventListener('click', function(e){ e.preventDefault(); localStorage.removeItem(STORAGE_KEY); $id('filter-institucion').value=''; $id('filter-genero').value='ALL'; $id('filter-edad').value=''; defaultDates(); saveFilters(); });
  $id('btn-print').addEventListener('click', function(){ window.print(); });
  // export is an anchor; no special handler required

  // filters change events: save state but do NOT auto-refresh. Refresh only happens on 'Actualizar'.
  ['desde','hasta','filter-institucion','filter-genero','filter-edad'].forEach(id=>{ const el = $id(id); if(el) el.addEventListener('change', ()=>{ saveFilters(); }); });

  // initial population: load institutions and restore saved filters; do NOT auto-refresh — require explicit 'Actualizar'
  populateInstituciones().then(()=>{ loadFilters(); /* user must press Actualizar */ }).catch(e=>{ console.warn('populateInstituciones failed', e); loadFilters(); });
})();
</script>
{% endblock %}
